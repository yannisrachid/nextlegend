# üöÄ Projet : NextLegend ‚Äî Plateforme d‚Äôanalyse & scouting football (Streamlit)

## üéØ Objectif global

G√©n√©rer une webapp **Streamlit** nomm√©e **NextLegend** qui reproduit le corps complet d‚Äôune application d‚Äôanalyse/scouting de joueurs, avec :

1. **Dashboard ‚ÄúJoueur du jour‚Äù**,
2. **Analyse de joueurs**,
3. **Comparaison** (multi-joueurs et multi-saisons),
4. **Ranking** (classements par poste/championnat),
5. **Scouting / Recherche avanc√©e** (filtres, similarit√©),
6. **Pages techniques** (√Ä propos / Changelog minimal / Mentions).

**Important :**

* Ne JAMAIS utiliser le nom ‚ÄúDataScout‚Äù ni ses marques. Tout le branding = **NextLegend**.
* Source unique des donn√©es : **`wyscout_players_final.csv`** (pr√©sent localement dans le dossier data/ du projet).
* Si des colonnes manquent, **d√©tecter automatiquement** les noms proches et proposer un **mapping configurable**.
* App responsive, th√®me sombre, esth√©tique moderne.

---

## üß± Stack & librairies

* **Python 3.10+**, **Streamlit** (1.33+)
* **pandas**, **numpy**, **scikit-learn** (standardisation, similarit√©), **plotly** (radars, barres, distributions), **pydeck** (optionnel cartes)
* **mplsoccer** (librairie python de g√©n√©ration de radar, visualisations, pizza chart, voir des exemples dans les notebooks dans le dossier old_work)
* **streamlit-option-menu** (navigation), **streamlit-aggrid** ou **st.dataframe** (tables interactives)
* **pydantic** (validation config), **toml**/**yaml** (config mapping colonnes)
* **rapidfuzz** (fuzzy matching de noms de colonnes)
* **cache** : `st.cache_data` / `st.cache_resource`

---

## üìÅ Arborescence cible

```
nextlegend/
‚îú‚îÄ app.py
‚îú‚îÄ pages/
‚îÇ  ‚îú‚îÄ 01_Joueur_du_jour.py
‚îÇ  ‚îú‚îÄ 02_Analyse_de_joueurs.py
‚îÇ  ‚îú‚îÄ 03_Comparaison.py
‚îÇ  ‚îú‚îÄ 04_Ranking.py
‚îÇ  ‚îú‚îÄ 05_Scouting.py
‚îÇ  ‚îú‚îÄ 90_A_propos.py
‚îÇ  ‚îî‚îÄ 99_Changelog.py
‚îú‚îÄ data/
‚îÇ  ‚îî‚îÄ wyscout_players_final.csv
‚îú‚îÄ config/
‚îÇ  ‚îú‚îÄ schema_map.yaml
‚îÇ  ‚îî‚îÄ settings.toml
‚îú‚îÄ components/
‚îÇ  ‚îú‚îÄ charts_radar.py
‚îÇ  ‚îú‚îÄ charts_bars.py
‚îÇ  ‚îú‚îÄ metrics_cards.py
‚îÇ  ‚îú‚îÄ player_badges.py
‚îÇ  ‚îú‚îÄ similarity.py
‚îÇ  ‚îî‚îÄ tables.py
‚îú‚îÄ assets/
‚îÇ  ‚îú‚îÄ logo_nextlegend.png
‚îÇ  ‚îî‚îÄ favicon.ico
‚îî‚îÄ styles/
   ‚îî‚îÄ theme.css
```

---

## üîå Donn√©es & Sch√©ma (bas√© Wyscout)

**Fichier :** `data/wyscout_players_final.csv`
**Exemples de colonnes attendues (adaptables) :**

* Identit√© : `player_id`, `player_name`, `age`, `height_cm`, `nationality`, `strong_foot`
* Contexte : `team`, `league`, `season`, `minutes`, `matches`
* Postes : `position`, `role_primary`, `role_secondary`
* Cr√©ation : `assists`, `xA`, `key_passes`, `deep_completions`, `crosses_completed`
* Finition : `goals`, `npxG`, `shots_on_target`, `conversion_rate`
* Portage/Dribbles : `dribbles_attempted`, `dribbles_succeeded`, `progressive_runs`, `progressive_carries`
* Construction/Passes : `passes_completed`, `passes_attempted`, `progressive_passes`, `final_third_passes`, `long_pass_accuracy`
* D√©fense : `interceptions`, `tackles_sliding`, `def_duels_won`, `def_duels_total`, `blocks`, `fouls`
* A√©rien : `aerial_duels_won`, `aerial_duels_total`, `headed_goals`
* Discipline : `yellow_cards`, `red_cards`

**Exigences :**

* Charger le CSV, convertir types, g√©rer valeurs manquantes.
* Cr√©er **KPIs par 90** : `stat_per90 = stat * 90 / minutes` (s√©curiser `minutes > 0`).
* Cr√©er **centiles** par **cohorte** (au minimum par **poste**; id√©alement par `poste + ligue` et √©ventuellement **seuil minutes** configurable, ex. `minutes >= 450`).
* Normaliser (z-score) les features utiles pour similarit√©.
* **Mapping de sch√©ma** automatique : si la colonne n‚Äôexiste pas, tenter `rapidfuzz` pour trouver la plus proche et alerter l‚Äôutilisateur (panneau config).

---

## üß≠ Navigation de l‚Äôapp

* Barre lat√©rale : logo NextLegend + s√©lecteurs globaux (saison, ligue, seuil minutes), commutateur th√®me clair/sombre (si possible via CSS).
* **Onglets/pages** :

  1. **Joueur du jour** (dashboard focalis√©)
  2. **Analyse de joueurs** (profil complet)
  3. **Comparaison** (jusqu‚Äô√† 4 joueurs / 2 saisons)
  4. **Ranking** (classements filtrables)
  5. **Scouting** (recherche multicrit√®res + similarit√©)
  6. **A propos / Changelog** (texte simple)

---

## üìä Composants & visuels

### Charts Radar (plotly)

* Fonction `radar_centiles(player_row, feature_groups, cohort_frame)`
* Couleur primaire NextLegend, trac√©s semi-transparents pour comparaisons, tooltip activ√©.
* Deux modes : **Centiles** (par d√©faut) et **Valeurs per90** (toggle).

### Barres horizontales par cat√©gorie

* Cat√©gories : **Finition**, **Cr√©ation**, **Offensif**, **Construction**, **Pr√©cision**, **A√©rien**, **D√©fense**.
* Entr√©es = centiles (0‚Äì100) calcul√©s dans la cohorte active.
* Option ‚Äúafficher valeurs exactes‚Äù (per90) sous la barre.

### Cartes de m√©triques (metrics_cards)

* `matches`, `minutes`, `goals`, `assists`, `xG`, `xA`, `succ_dribbles`, `prog_runs`, `def_duels_win_rate`, `aerial_win_rate`, etc.
* KPI composite **Performance Index** (pond√©rations configurables, cf. `settings.toml`).

### Badges joueur (player_badges)

* √Çge, taille, pied fort, postes, pays, club, saison.

### Tables

* **Tables interactives** (AgGrid ou DataFrame) avec tri, filtre, export CSV.

---

## üß© Pages ‚Äî Comportement d√©taill√©

### 1) Joueur du jour (`01_Joueur_du_jour.py`)

* S√©lection **al√©atoire pond√©r√©e** (ex. joueurs avec minutes ‚â• seuil) OU ‚Äúdernier profil consult√©‚Äù.
* Afficher :

  * En-t√™te (nom, club, poste, saison), **Performance Index**, **Meilleur r√¥le** (d√©duit du poste/role_primary)
  * **Forces / Axes d‚Äôam√©lioration** :

    * Forces = top 5 centiles > 80 (sur un pool de features cl√©s)
    * Axes = 5 plus faibles centiles (< 30)
  * **Radar centiles** (features cl√©s)
  * **Barres par cat√©gorie**
  * Bloc "m√©tadonn√©es" (matches, minutes, etc.)

### 2) Analyse de joueurs (`02_Analyse_de_joueurs.py`)

* Filtres : saison, ligue, √©quipe, poste, nom joueur.
* Panneau gauche : carte identit√© + m√©triques.
* Panneau droit :

  * Radar (toggle centiles/valeurs)
  * Barres cat√©gories
  * **Distribution de cohorte** (violin/box pour situer le joueur sur 1‚Äì2 features au choix)
* Bouton ‚ÄúCopier l‚Äôimage du radar‚Äù (export PNG via `plotly.io.to_image`)

### 3) Comparaison (`03_Comparaison.py`)

* Choisir **jusqu‚Äô√† 4 joueurs** (ou 1 joueur √ó 2 saisons).
* Radars superpos√©s (couleurs distinctes).
* Tableau comparatif (centiles et valeurs per90) ‚Äî colonnes = joueurs/saisons.
* Mini-heatmap de centiles pour lecture rapide.

### 4) Ranking (`04_Ranking.py`)

* Filtres : poste (obligatoire), saison, ligue(s), seuil minutes.
* Choix de **m√©trique de tri** (ex. `progressive_passes_per90`, `xA_per90`, `def_duels_win_rate`, **Performance Index**).
* Table triable + sparklines (si historique multi-saisons).
* Bouton ‚ÄúEnregistrer la shortlist‚Äù (√©crit un CSV export dans `/data/exports/`).

### 5) Scouting (`05_Scouting.py`)

* Filtres multiples : √¢ge (min‚Äìmax), taille, pied, poste, ligue, minutes, m√©triques (sliders), statut contrat (si dispo).
* **Similarit√©** :

  * Entr√©e = ‚ÄúJoueur r√©f√©rence‚Äù + **poids par cat√©gorie** (Cr√©ation/D√©fense/Offensif/Construction/Pr√©cision/A√©rien).
  * Standardiser features, calcul **cosine similarity**.
  * Restituer top N profils similaires avec cartes + mini-radar par joueur.
* Toggle ‚Äúm√™me pied fort‚Äù, ‚Äúm√™me poste‚Äù.

### 6) √Ä propos / Changelog

* Texte statique, version app, liens (internes).

---

## üßÆ Calculs & indicateurs

### Per 90

```
safe_per90(value, minutes) = value * 90 / max(minutes, 1)
```

### Taux (%)

```
win_rate = won / max(total, 1)
accuracy = completed / max(attempted, 1)
```

### Centiles par cohorte

* D√©finir cohorte par d√©faut : `poste` (+ option `ligue`) avec filtre `minutes >= seuil`.
* Utiliser `scipy.stats.rankdata` ou `pandas.qcut`/`percentileofscore`.
* Stocker centiles pour chaque *feature cl√©* dans un DataFrame ‚Äúlong‚Äù exploitable par les charts.

### Performance Index (exemple)

* Pond√©rations configurables (`settings.toml`) par cat√©gorie :

  * Cr√©ation 25%, Offensif 15%, Construction 15%, Pr√©cision 10%, D√©fense 20%, A√©rien 10%, Finition 5%.
* Calculer par moyenne pond√©r√©e de centiles.

---

## ‚öôÔ∏è Fichiers de config

### `config/schema_map.yaml`

* Dictionnaire `nom_interne: [candidats_csv]`
* Exemple :

```yaml
player_name: ["player_name", "name", "player"]
minutes: ["minutes", "mins_played", "time_played"]
goals: ["goals", "goals_total"]
xA: ["xa", "expected_assists", "x_assist"]
progressive_passes: ["progressive_passes", "prog_passes"]
```

### `config/settings.toml`

```toml
[min_thresholds]
minutes = 450

[index_weights]
finition = 0.05
creation = 0.25
offensif = 0.15
construction = 0.15
precision = 0.10
defense = 0.20
aerien = 0.10

[ui]
theme = "dark"
primary_color = "#7BD389"
accent_color = "#FF7A59"
```

---

## üß∞ Composants √† g√©n√©rer (stubs + code)

* `components/charts_radar.py`

  * `make_radar(df_centiles_long, entities, features_groups, mode="centile") -> plotly.Figure`
* `components/charts_bars.py`

  * `bars_by_category(centiles_dict: dict[str, dict[str,int]]) -> list[plotly.Figure]`
* `components/metrics_cards.py`

  * `render_metrics(player_row)`
* `components/player_badges.py`

  * `render_badges(player_row)`
* `components/similarity.py`

  * `standardize(df, features)`
  * `cosine_sim_matrix(df_std[features])`
  * `top_similar(df_std, ref_player_id, features, top_n=20, same_foot=None, same_position=None, weights_by_category=None)`
* `components/tables.py`

  * `ranking_table(df, sort_metric, ascending=False)`
  * `comparison_table(df_players, features)`

---

## üß™ Exigences UX

* **Th√®me sombre** + **CSS** personnalis√© (`styles/theme.css`) : coins arrondis, cartes, micro-ombres, espaces.
* √âl√©ments UI : selectbox, multiselect, sliders, radio/toggles (‚ÄúCentiles‚Äù vs ‚ÄúValeurs per90‚Äù), boutons ‚ÄúExporter PNG/CSV‚Äù.
* **Performance** : cache des DataFrames d√©riv√©s (per90, centiles, index).
* **Robustesse** : si colonne manquante ‚Üí afficher **alerte + suggestion mapping**.

---

## ‚úÖ Crit√®res d‚Äôacceptation

* Lancement avec `streamlit run app.py`.
* Les pages chargent sans erreur avec `wyscout_players_final.csv`.
* Un joueur affiche radar + barres + forces/faiblesses + m√©triques.
* Comparaison superpose correctement les radars et aligne les tableaux.
* Ranking trie et filtre sans lag (>5k lignes OK).
* Scouting renvoie une **liste de joueurs similaires** cr√©dible (+ filtres).

---

## üß≠ T√¢ches de g√©n√©ration pour Codex (ordre)

1. Cr√©er l‚Äôarborescence et les fichiers vides.
2. Impl√©menter `app.py` (page d‚Äôaccueil + routing Streamlit multi-pages).
3. Impl√©menter **chargement CSV + mapping dynamique** (`schema_map.yaml`).
4. Impl√©menter calculs per90, centiles, index.
5. G√©n√©rer **01_Joueur_du_jour** (avec logic joueur al√©atoire et UI compl√®te).
6. G√©n√©rer **02_Analyse_de_joueurs** (profil complet).
7. G√©n√©rer **03_Comparaison** (jusqu‚Äô√† 4 joueurs + tableau).
8. G√©n√©rer **04_Ranking** (filtres + tri + export).
9. G√©n√©rer **05_Scouting** (filtres + similarit√© + mini-radars).
10. Ajouter **styles/theme.css** et finitions visuelles.

---

## ‚ñ∂Ô∏è Commande de lancement

```bash
streamlit run app.py
```

**Nom de l‚Äôapp, logos, textes, couleurs** : utiliser exclusivement la marque **NextLegend**.
